From 60b2b659f3aeba0dc67b9518155fa5619c9f6544 Mon Sep 17 00:00:00 2001
In-Reply-To: <20210111144740.6092-1-avarab@gmail.com>
References: <20210111144740.6092-1-avarab@gmail.com>
From: Ævar Arnfjörð Bjarmason <avarab@gmail.com>
Date: Wed, 20 Jan 2021 19:14:15 +0100
Subject: [PATCH v2 0/7] *** SUBJECT HERE ***
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

*** BLURB HERE ***

Ævar Arnfjörð Bjarmason (7):
  ci: remove GETTEXT_POISON jobs
  tests: remove support for GIT_TEST_GETTEXT_POISON
  tests: remove misc use of test_i18n{cmp,grep}
  tests: (almost) remove use of "test_i18ngrep !"
  tests: (almost) remove C_LOCALE_OUTPUT prerequisites
  tests: remove uses of GIT_TEST_GETTEXT_POISON=false
  rebase tests: remove comment about gettext poison

 .github/workflows/main.yml                    |  2 +-
 .travis.yml                                   |  2 +-
 Documentation/MyFirstContribution.txt         |  2 +-
 ci/install-dependencies.sh                    |  2 +-
 ci/lib.sh                                     |  3 +-
 config.c                                      |  9 -----
 .../t/t9363-mw-to-git-export-import.sh        |  2 +-
 gettext.c                                     | 10 -----
 gettext.h                                     |  7 +---
 git-sh-i18n.sh                                | 22 +----------
 po/README                                     | 22 +----------
 t/README                                      |  6 ---
 t/lib-credential.sh                           |  2 +-
 t/lib-gettext.sh                              |  2 +-
 t/lib-httpd.sh                                |  2 +-
 t/lib-log-graph.sh                            |  4 +-
 t/lib-rebase.sh                               |  1 -
 t/lib-submodule-update.sh                     |  2 +-
 t/t0000-basic.sh                              |  2 +-
 t/t0017-env-helper.sh                         |  8 ++--
 t/t0020-crlf.sh                               |  6 +--
 t/t0041-usage.sh                              | 12 +++---
 t/t0201-gettext-fallbacks.sh                  |  2 +-
 t/t0205-gettext-poison.sh                     | 39 -------------------
 t/t1060-object-corruption.sh                  |  2 +-
 t/t1091-sparse-checkout-builtin.sh            | 10 ++---
 t/t1305-config-include.sh                     |  4 +-
 t/t1430-bad-ref-name.sh                       |  2 +-
 t/t1450-fsck.sh                               |  4 +-
 t/t1506-rev-parse-diagnosis.sh                |  2 +-
 t/t1512-rev-parse-disambiguation.sh           | 14 +++----
 t/t2019-checkout-ambiguous-ref.sh             |  4 +-
 t/t2020-checkout-detach.sh                    |  4 +-
 t/t2024-checkout-dwim.sh                      |  2 +-
 t/t3404-rebase-interactive.sh                 | 14 +++----
 t/t3406-rebase-message.sh                     |  7 ----
 t/t3415-rebase-autosquash.sh                  | 10 ++---
 t/t3418-rebase-continue.sh                    |  2 +-
 t/t3507-cherry-pick-conflict.sh               |  2 +-
 t/t3600-rm.sh                                 |  2 +-
 t/t3701-add-interactive.sh                    |  2 +-
 t/t4001-diff-rename.sh                        |  2 +-
 t/t4012-diff-binary.sh                        |  4 +-
 t/t4014-format-patch.sh                       |  2 +-
 t/t4018-diff-funcname.sh                      |  8 ++--
 t/t4153-am-resume-override-opts.sh            |  2 +-
 t/t4205-log-pretty-formats.sh                 |  2 +-
 t/t5300-pack-object.sh                        |  4 +-
 t/t5324-split-commit-graph.sh                 |  2 +-
 t/t5411/common-functions.sh                   |  5 +--
 t/t5411/test-0026-push-options.sh             |  3 +-
 t/t5411/test-0027-push-options--porcelain.sh  |  3 +-
 t/t5505-remote.sh                             |  8 ++--
 t/t5510-fetch.sh                              |  6 +--
 t/t5534-push-signed.sh                        |  2 +-
 t/t5541-http-push-smart.sh                    |  4 +-
 t/t5580-unc-paths.sh                          |  2 +-
 t/t5601-clone.sh                              |  2 +-
 t/t5606-clone-options.sh                      |  2 +-
 t/t6001-rev-list-graft.sh                     |  2 +-
 t/t6050-replace.sh                            |  2 +-
 t/t6423-merge-rename-directories.sh           | 14 +++----
 t/t6433-merge-toplevel.sh                     |  2 +-
 t/t6437-submodule-merge.sh                    |  2 +-
 t/t6500-gc.sh                                 |  2 +-
 t/t7201-co.sh                                 |  2 +-
 t/t7300-clean.sh                              |  6 +--
 t/t7400-submodule-basic.sh                    | 16 ++++----
 t/t7414-submodule-mistakes.sh                 |  6 +--
 t/t7415-submodule-names.sh                    |  2 +-
 t/t7416-submodule-dash-url.sh                 |  2 +-
 t/t7502-commit-porcelain.sh                   | 10 ++---
 t/t7508-status.sh                             |  8 ++--
 t/t7518-ident-corner-cases.sh                 |  2 +-
 t/t7519-status-fsmonitor.sh                   |  4 +-
 t/t7520-ignored-hook-warning.sh               |  6 +--
 t/t7601-merge-pull-config.sh                  | 34 ++++++++--------
 t/t7810-grep.sh                               |  4 +-
 t/t7816-grep-binary-pattern.sh                |  2 +-
 t/t9003-help-autocorrect.sh                   |  7 +---
 t/t9800-git-p4-basic.sh                       |  2 +-
 t/t9807-git-p4-submit.sh                      |  2 +-
 t/t9902-completion.sh                         |  1 -
 t/test-lib-functions.sh                       | 23 ++++-------
 t/test-lib.sh                                 | 23 ++---------
 85 files changed, 178 insertions(+), 329 deletions(-)
 delete mode 100755 t/t0205-gettext-poison.sh

Range-diff:
1:  00c5326694 ! 1:  164296c7d6 ci: remove GETTEXT_POISON jobs
    @@ Commit message
         by removing the CI jobs that enable the option.
     
         We cannot just remove the job because the CI is implicitly depending
    -    on the "poison" job being a sort of "default" job. Let's instead add a
    -    "default" job.
    +    on the "poison" job being a sort of "default" job in the sense that
    +    it's the job that was otherwise run with the default compiler, no
    +    other GIT_TEST_* options etc. So let's keep it under the name
    +    "linux-gcc-default".
     
         This means we can remove the initial "make test" from the "linux-gcc"
         job (it does another one after setting a bunch of GIT_TEST_*
2:  ac0f3a78d7 ! 2:  e254856b54 tests: remove support for GIT_TEST_GETTEXT_POISON
    @@ Commit message
         we still have a lot of test_i18n, C_LOCALE_OUTPUT
         etc. uses. Subsequent commits will remove those too.
     
    +    The change to t/lib-rebase.sh is a selective revert of the relevant
    +    part of f2d17068fd (i18n: rebase-interactive: mark comments of squash
    +    for translation, 2016-06-17).
    +
         Signed-off-by: Ævar Arnfjörð Bjarmason <avarab@gmail.com>
     
      ## Documentation/MyFirstContribution.txt ##
    @@ po/README: Perl:
     -something in the test suite might still depend on the US English
     -version of the strings, e.g. to grep some error message or other
     -output.
    -+Git's tests are run under LANG=C LC_ALL=C. So the tests do not need be
    -+changed to account for translations as they're added.
    - 
    +-
     -To smoke out issues like these, Git tested with a translation mode that
     -emits gibberish on every call to gettext. To use it run the test suite
     -with it, e.g.:
    -+Testing whether marked strings are used by plumbing
    -+---------------------------------------------------
    - 
    +-
     -    cd t && GIT_TEST_GETTEXT_POISON=true prove -j 9 ./t[0-9]*.sh
    -+It may be useful to use the test suite to smoke out any strings that
    -+shouldn't be translated, because they are used by plumbing or
    -+otherwise part of machine-readable output.
    - 
    +-
     -If tests break with it you should inspect them manually and see if
     -what you're translating is sane, i.e. that you're not translating
    -+This is most useful in cases where e.g. library function might return
    -+a string like _("tree"), and the developer marking strings for
    -+translation wishes to check that they're not inadvertently translating
    - plumbing output.
    - 
    +-plumbing output.
    +-
     -If not you should replace calls to grep with test_i18ngrep, or
     -test_cmp calls with test_i18ncmp. If that's not enough you can skip
     -the whole test by making it depend on the C_LOCALE_OUTPUT
     -prerequisite. See existing test files with this prerequisite for
     -examples.
    -+There used to be a GIT_TEST_GETTEXT_POISON=true test mode to replace
    -+translated strings with gibberish to facilitate this. Maintaining it
    -+and annotating tests appropriately was considered too high of a burden
    -+for its usefulness.
    -+
    -+It's still possible to do a one-off test of where a string might be
    -+used in the tests by simply replacing the "some hardcoded string" with
    -+something like "POISON ME" locally and running the tests, before
    -+finally converting it to _("some hardcoded string").
    ++Git's tests are run under LANG=C LC_ALL=C. So the tests do not need be
    ++changed to account for translations as they're added.
     
      ## t/README ##
     @@ t/README: whether this mode is active, and e.g. skip some tests that are hard to
    @@ t/lib-gettext.sh: else
      	# is_IS.UTF-8 on Solaris and FreeBSD, is_IS.utf8 on Debian
      	is_IS_locale=$(locale -a 2>/dev/null |
     
    + ## t/lib-rebase.sh ##
    +@@ t/lib-rebase.sh: set_fake_editor () {
    + 	*/COMMIT_EDITMSG)
    + 		test -z "$EXPECT_HEADER_COUNT" ||
    + 			test "$EXPECT_HEADER_COUNT" = "$(sed -n '1s/^# This is a combination of \(.*\) commits\./\1/p' < "$1")" ||
    +-			test "# # GETTEXT POISON #" = "$(sed -n '1p' < "$1")" ||
    + 			exit
    + 		test -z "$FAKE_COMMIT_MESSAGE" || echo "$FAKE_COMMIT_MESSAGE" > "$1"
    + 		test -z "$FAKE_COMMIT_AMEND" || echo "$FAKE_COMMIT_AMEND" >> "$1"
    +
      ## t/t0017-env-helper.sh ##
     @@ t/t0017-env-helper.sh: test_expect_success 'env--helper reads config thanks to trace2' '
      	git config -f home/cycle include.path .gitconfig &&
3:  8bdf8d9513 = 3:  8a89a9f43a tests: remove misc use of test_i18n{cmp,grep}
4:  ead017acc8 = 4:  7a7548d8b1 tests: (almost) remove use of "test_i18ngrep !"
5:  b1113122d0 = 5:  36fa64bae0 tests: (almost) remove C_LOCALE_OUTPUT prerequisites
6:  9226c3a2df = 6:  fe362759df tests: remove uses of GIT_TEST_GETTEXT_POISON=false
-:  ---------- > 7:  60b2b659f3 rebase tests: remove comment about gettext poison
-- 
2.29.2.222.g5d2a92d10f8

