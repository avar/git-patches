From 2ff4562d5362130192c256580810d386169e222d Mon Sep 17 00:00:00 2001
Message-Id: <patch-v8-05.12-2ff4562d536-20220118T155150Z-avarab@gmail.com>
In-Reply-To: <cover-v8-00.12-00000000000-20220118T155150Z-avarab@gmail.com>
References: <cover-v7-00.10-00000000000-20211228T004707Z-avarab@gmail.com>
	<cover-v8-00.12-00000000000-20220118T155150Z-avarab@gmail.com>
From: =?UTF-8?q?=C3=86var=20Arnfj=C3=B6r=C3=B0=20Bjarmason?=
 <avarab@gmail.com>
Date: Thu, 4 Feb 2021 16:03:30 +0100
Subject: [PATCH v8 05/12] wip reg_newline etc. test

---
 grep.c                 |  2 +-
 t/t4209-log-pickaxe.sh | 10 ++++++++--
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/grep.c b/grep.c
index 9064c714500..b2c55eca37a 100644
--- a/grep.c
+++ b/grep.c
@@ -444,7 +444,7 @@ static void compile_fixed_regexp(struct grep_pat *p, struct grep_opt *opt)
 static void compile_regexp(struct grep_pat *p, struct grep_opt *opt)
 {
 	int err;
-	int regflags = 0; //REG_NEWLINE;
+	int regflags = 0;
 
 	p->word_regexp = opt->word_regexp;
 	p->ignore_case = opt->ignore_case;
diff --git a/t/t4209-log-pickaxe.sh b/t/t4209-log-pickaxe.sh
index f1f11042838..91c622175a2 100755
--- a/t/t4209-log-pickaxe.sh
+++ b/t/t4209-log-pickaxe.sh
@@ -149,7 +149,7 @@ test_expect_success 'log -S --no-textconv (missing textconv tool)' '
 test_expect_success 'setup log -[GS] plain & regex' '
 	test_create_repo GS-plain &&
 	test_commit -C GS-plain --append A data.txt "a" &&
-	test_commit -C GS-plain --append B data.txt "a a" &&
+	test_commit -C GS-plain --append B data.txt "aa" &&
 	test_commit -C GS-plain --append C data.txt "b" &&
 	test_commit -C GS-plain --append D data.txt "[b]" &&
 	test_commit -C GS-plain E data.txt "" &&
@@ -158,6 +158,7 @@ test_expect_success 'setup log -[GS] plain & regex' '
 	git -C GS-plain log --grep="[ABE]" >A-to-B-then-E-log &&
 	git -C GS-plain log --grep="[CDE]" >C-to-D-then-E-log &&
 	git -C GS-plain log --grep="[DE]" >D-then-E-log &&
+	git -C GS-plain log --grep="[AE]" >A-then-E-log &&
 	git -C GS-plain log >full-log
 '
 
@@ -165,7 +166,12 @@ test_expect_success 'log -G trims diff new/old [-+]' '
 	git -C GS-plain log -G"[+-]a" >log &&
 	test_must_be_empty log &&
 	git -C GS-plain log -G"^a" >log &&
-	test_cmp log A-to-B-then-E-log
+	test_cmp A-to-B-then-E-log log
+'
+
+test_expect_success 'log -S --pickaxe-regex uses REG_NOTBOL for subsequent matches' '
+	git -C GS-plain log -S"^a" --pickaxe-regex >log &&
+	test_cmp A-then-E-log log
 '
 
 test_expect_success 'log -S<pat> is not a regex, but -S<pat> --pickaxe-regex is' '
-- 
2.35.0.rc1.864.g57621b115b6

