From 29ab2895b77ec2fd0339ab7ad336f004d4a94652 Mon Sep 17 00:00:00 2001
In-Reply-To: <20190221223753.20070-1-avarab@gmail.com>
References: <20190221223753.20070-1-avarab@gmail.com>
From: =?UTF-8?q?=C3=86var=20Arnfj=C3=B6r=C3=B0=20Bjarmason?=
 <avarab@gmail.com>
Date: Thu, 14 Mar 2019 22:33:33 +0100
Subject: [PATCH v2 0/8] *** SUBJECT HERE ***
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

*** BLURB HERE ***

Ævar Arnfjörð Bjarmason (8):
  commit-graph tests: split up corrupt_graph_and_verify()
  commit-graph tests: test a graph that's too small
  commit-graph: fix segfault on e.g. "git status"
  commit-graph: don't early exit(1) on e.g. "git status"
  commit-graph: don't pass filename to load_commit_graph_one_fd_st()
  commit-graph verify: detect inability to read the graph
  commit-graph write: don't die if the existing graph is corrupt
  commit-graph: improve & i18n error messages

 builtin/commit-graph.c  |  23 +++++--
 commit-graph.c          | 132 +++++++++++++++++++++++++++-------------
 commit-graph.h          |   4 ++
 commit.h                |   6 ++
 t/t5318-commit-graph.sh |  42 +++++++++++--
 5 files changed, 154 insertions(+), 53 deletions(-)

Range-diff:
  -:  ---------- >   1:  0ecb1fc726 branch: introduce --show-current display option
  -:  ---------- >   2:  42617752d4 doc: group pretty-format.txt placeholders descriptions
  -:  ---------- >   3:  b0340175b6 l10n: Update Catalan translation
  -:  ---------- >   4:  25c759021f l10n: zh_CN: fix typo of submodule init message
  -:  ---------- >   5:  a0cc58450a move worktree tests to t24*
  -:  ---------- >   6:  b702dd12d5 entry: factor out unlink_entry function
  -:  ---------- >   7:  536ec1839d entry: support CE_WT_REMOVE flag in checkout_entry
  -:  ---------- >   8:  6fdc205722 read-cache: add invalidate parameter to remove_marked_cache_entries
  -:  ---------- >   9:  5160fa0562 checkout: clarify comment
  -:  ---------- >  10:  b7033e73b7 checkout: factor out mark_cache_entry_for_checkout function
  -:  ---------- >  11:  091e04bc8c checkout: introduce --{,no-}overlay option
  -:  ---------- >  12:  1495ff7da5 checkout: introduce checkout.overlayMode config
  -:  ---------- >  13:  1987b0b20f parse-options.h: remove extern on function prototypes
  -:  ---------- >  14:  202fbb3315 parse-options: add one-shot mode
  -:  ---------- >  15:  baa4adc66a parse-options: disable option abbreviation with PARSE_OPT_KEEP_UNKNOWN
  -:  ---------- >  16:  f62470c650 parse-options: add OPT_BITOP()
  -:  ---------- >  17:  bf3ff338a2 parse-options: stop abusing 'callback' for lowlevel callbacks
  -:  ---------- >  18:  f41179f16b parse-options: avoid magic return codes
  -:  ---------- >  19:  3ebbe28989 parse-options: allow ll_callback with OPTION_CALLBACK
  -:  ---------- >  20:  4a1b13a397 diff.h: keep forward struct declarations sorted
  -:  ---------- >  21:  2b393ef357 diff.h: avoid bit fields in struct diff_flags
  -:  ---------- >  22:  4a28847839 diff.c: prepare to use parse_options() for parsing
  -:  ---------- >  23:  cc013c224c diff.c: convert -u|-p|--patch
  -:  ---------- >  24:  d473e2e0e8 diff.c: convert -U|--unified
  -:  ---------- >  25:  7fd9a1ba03 diff.c: convert -W|--[no-]function-context
  -:  ---------- >  26:  ed88148674 diff.c: convert --raw
  -:  ---------- >  27:  4f732e0fd7 pretty: allow %(trailers) options with explicit value
  -:  ---------- >  28:  3e3f347819 pretty: single return path in %(trailers) handling
  -:  ---------- >  29:  250bea0c16 pretty: allow showing specific trailers
  -:  ---------- >  30:  d9b936db52 pretty: add support for "valueonly" option in %(trailers)
  -:  ---------- >  31:  fd2015b323 strbuf: separate callback for strbuf_expand:ing literals
  -:  ---------- >  32:  0b691d8685 pretty: add support for separator option in %(trailers)
  -:  ---------- >  33:  39ab4d0951 config: allow giving separate author and committer idents
  -:  ---------- >  34:  e92aa0e4ef revert "checkout: introduce checkout.overlayMode config"
  -:  ---------- >  35:  3173a94d57 t5323: test cases for git-pack-redundant
  -:  ---------- >  36:  3011177640 pack-redundant: delay creation of unique_objects
  -:  ---------- >  37:  8822859363 pack-redundant: delete redundant code
  -:  ---------- >  38:  3084a01e5e pack-redundant: new algorithm to find min packs
  -:  ---------- >  39:  4bc0cc12c1 pack-redundant: rename pack_list.all_objects
  -:  ---------- >  40:  0e37abd2e8 pack-redundant: consistent sort method
  -:  ---------- >  41:  db7750cfbe completion: complete git submodule absorbgitdirs
  -:  ---------- >  42:  d76ce4f734 log,diff-tree: add --combined-all-paths option
  -:  ---------- >  43:  94328ceff0 l10n: git.pot: v2.21.0 round 1 (214 new, 38 removed)
  -:  ---------- >  44:  11f470aee7 test: caution on our version of 'yes'
  -:  ---------- >  45:  9b0bd87ed2 prune-packed: check for too many arguments
  -:  ---------- >  46:  6e37c8ed3c read-cache.c: fix writing "link" index ext with null base oid
  -:  ---------- >  47:  d38722eb10 tests: avoid syntax triggering old dash bug
  -:  ---------- >  48:  7d50d34fc7 remote-curl: reduce scope of rpc_state.argv
  -:  ---------- >  49:  5d91669309 remote-curl: reduce scope of rpc_state.stdin_preamble
  -:  ---------- >  50:  b35903092e remote-curl: reduce scope of rpc_state.result
  -:  ---------- >  51:  d55a30bb1d prune: lazily perform reachability traversal
  -:  ---------- >  52:  fde67d6896 prune: use bitmaps for reachability traversal
  -:  ---------- >  53:  c2bf473d0d prune: check SEEN flag for reachability
  -:  ---------- >  54:  cc80c95f42 t5304: rename "sha1" variables to "oid"
  -:  ---------- >  55:  784c0daed5 diff: drop options parameter from diffcore_fix_diff_index()
  -:  ---------- >  56:  e04df61256 diff: drop unused color reset parameters
  -:  ---------- >  57:  19b9046eed diff: drop unused emit data parameter from sane_truncate_line()
  -:  ---------- >  58:  4bc1792750 diff: drop complete_rewrite parameter from run_external_diff()
  -:  ---------- >  59:  b53c502807 merge-recursive: drop several unused parameters
  -:  ---------- >  60:  c409d108b8 pack-objects: drop unused parameter from oe_map_new_pack()
  -:  ---------- >  61:  10dee40ed3 files-backend: drop refs parameter from split_symref_update()
  -:  ---------- >  62:  e0329199a7 ref-filter: drop unused buf/sz pairs
  -:  ---------- >  63:  25051cac80 ref-filter: drop unused "obj" parameters
  -:  ---------- >  64:  5c326d1252 ref-filter: drop unused "sz" parameters
  -:  ---------- >  65:  7f95bc7a20 l10n: git.pot: v2.21.0 round 2 (3 new, 3 removed)
  -:  ---------- >  66:  bdc017d268 l10n: Fixes to Catalan translation
  -:  ---------- >  67:  68cabbfda3 submodule: document default behavior
  -:  ---------- >  68:  5a05494049 l10n: fr.po Fix some typos
  -:  ---------- >  69:  02705d38d4 l10n: fr.po Fix some typos from round3
  -:  ---------- >  70:  b3225a4183 l10n: fr.po v2.21.0 rnd 2
  -:  ---------- >  71:  4953cf69a3 l10n: el: add Greek l10n team and essential translations
  -:  ---------- >  72:  cf69bcadee l10n: es: 2.21.0 round 2
  -:  ---------- >  73:  bb236fb44a l10n: it: update the Italian translation
  -:  ---------- >  74:  567349f54e l10n: de.po: consistent translation of 'root commit'
  -:  ---------- >  75:  40cbe8ad14 l10n: de.po: fix a message for index-pack.c
  -:  ---------- >  76:  a8a6b15c01 l10n: de.po: fix grammar in message for tag.c
  -:  ---------- >  77:  34692d22fa l10n: Update Swedish translation (4363t0f0u)
  -:  ---------- >  78:  c2d8f4c73a l10n: bg.po: correct typo
  -:  ---------- >  79:  069917778f l10n: zh_CN: for git v2.21.0 l10n round 1~2
  -:  ---------- >  80:  8e4e0555f2 l10n: zh_CN: Revision for git v2.21.0 l10n
  -:  ---------- >  81:  5a59a2301f completion: add more parameter value completion
  -:  ---------- >  82:  c659f30398 diff-parseopt: convert --patch-with-raw
  -:  ---------- >  83:  e56736203e diff-parseopt: convert --numstat and --shortstat
  -:  ---------- >  84:  9903623761 receive-pack: fix use-after-free bug
  -:  ---------- >  85:  3e14dd2c8e mention use of "hooks.allownonascii" in "man githooks"
  -:  ---------- >  86:  1ede45e44b merge-options.txt: correct wording of --no-commit option
  -:  ---------- >  87:  90503a240b protocol-capabilities.txt: document symref
  -:  ---------- >  88:  4ce7aab5a5 diff-parseopt: convert --dirstat and friends
  -:  ---------- >  89:  fc6af3e92a diff-parseopt: convert --check
  -:  ---------- >  90:  70a304179a diff-parseopt: convert --summary
  -:  ---------- >  91:  e550f58551 diff-parseopt: convert --patch-with-stat
  -:  ---------- >  92:  0e840e2af4 diff-parseopt: convert --name-only
  -:  ---------- >  93:  a23874726b diff-parseopt: convert --name-status
  -:  ---------- >  94:  e01df7a33d diff-parseopt: convert -s|--no-patch
  -:  ---------- >  95:  84b5089e41 diff-parseopt: convert --stat*
  -:  ---------- >  96:  7d7942b796 diff-parseopt: convert --[no-]compact-summary
  -:  ---------- >  97:  af2f368091 diff-parseopt: convert --output-*
  -:  ---------- >  98:  ced4e179fe diff-parseopt: convert -B|--break-rewrites
  -:  ---------- >  99:  f476308b27 diff-parseopt: convert -M|--find-renames
  -:  ---------- > 100:  1e5332968a diff-parseopt: convert -D|--irreversible-delete
  -:  ---------- > 101:  7f64850d36 diff-parseopt: convert -C|--find-copies
  -:  ---------- > 102:  bdd4741bfd diff-parseopt: convert --find-copies-harder
  -:  ---------- > 103:  cdc43eb0b8 diff-parseopt: convert --no-renames|--[no--rename-empty
  -:  ---------- > 104:  0b1c5b59f0 diff-parseopt: convert --relative
  -:  ---------- > 105:  2e75f922f3 diff-parseopt: convert --[no-]minimal
  -:  ---------- > 106:  87649a1674 diff-parseopt: convert --ignore-some-changes
  -:  ---------- > 107:  4abf20f004 tests: fix unportable "\?" and "\+" regex syntax
  -:  ---------- > 108:  e5a5d5c2c8 l10n: update German translation
  -:  ---------- > 109:  b9cc405612 commit-graph tests: fix unportable "dd" invocation
  -:  ---------- > 110:  78ad91728d remote-curl: refactor reading into rpc_state's buf
  -:  ---------- > 111:  c271dc28fd Delete check-racy.c
  -:  ---------- > 112:  e544221d97 trace2: Documentation/technical/api-trace2.txt
  -:  ---------- > 113:  ee4512ed48 trace2: create new combined trace facility
  -:  ---------- > 114:  353d3d77f4 trace2: collect Windows-specific process information
  -:  ---------- > 115:  942b2740ff trace2:data: add trace2 regions to wt-status
  -:  ---------- > 116:  eee73d1dce trace2:data: add editor/pager child classification
  -:  ---------- > 117:  0671b4d193 trace2:data: add trace2 sub-process classification
  -:  ---------- > 118:  abd81a3d79 trace2:data: add trace2 transport child classification
  -:  ---------- > 119:  6206286e49 trace2:data: add trace2 hook classification
  -:  ---------- > 120:  42fee7a388 trace2:data: add trace2 instrumentation to index read/write
  -:  ---------- > 121:  ae417807b0 trace2:data: pack-objects: add trace2 regions
  -:  ---------- > 122:  e27dd8ae9f trace2:data: add subverb to checkout command
  -:  ---------- > 123:  c18b6c1a2b trace2:data: add subverb to reset command
  -:  ---------- > 124:  b3a5d5a80c trace2:data: add subverb for rebase
  -:  ---------- > 125:  a15860dca3 trace2: t/helper/test-trace2, t0210.sh, t0211.sh, t0212.sh
  -:  ---------- > 126:  a446f2dcc8 trace2: add for_each macros to clang-format
  -:  ---------- > 127:  ab8f4f5d73 l10n: bg.po: Updated Bulgarian translation (4363t)
  -:  ---------- > 128:  c5c0a5ff1d checkout doc: fix an unmatched double-quote pair
  -:  ---------- > 129:  39ffebd23b README: adjust for final Azure Pipeline ID
  -:  ---------- > 130:  287ab28bfa diff: reuse diff setup for --no-index case
  -:  ---------- > 131:  8104ec994e Git 2.21
  -:  ---------- > 132:  29b168aa44 l10n: fr.po remove obsolete entries
  -:  ---------- > 133:  dbf47215e3 rebase docs: fix "gitlink" typo
  -:  ---------- > 134:  50b206371d travis: remove the hack to build the Windows job on Azure Pipelines
  -:  ---------- > 135:  1fc5279fdb l10n: Updated Vietnamese translation for v2.21 rd2
  -:  ---------- > 136:  3ece05c5f4 l10n: Fixes to Catalan translation
  -:  ---------- > 137:  716a5af812 docs/git-gc: fix typo "--prune=all" to "--prune=now"
  -:  ---------- > 138:  a97d00799a remote-curl: use post_rpc() for protocol v2 also
  -:  ---------- > 139:  92b88eba9f Makefile: use `git ls-files` to list header files, if possible
  -:  ---------- > 140:  f23aa18e7f Makefile: fix 'hdr-check' when GCRYPT not installed
  -:  ---------- > 141:  33aa579a55 compat/bswap: add include header guards
  -:  ---------- > 142:  e6e15194a8 gitattributes.txt: fix typo
  -:  ---------- > 143:  bb101aaf0c attr.c: ".gitattribute" -> ".gitattributes" (comments)
  -:  ---------- > 144:  6e0cc67761 Start 2.22 cycle
  -:  ---------- > 145:  6053c04b88 mingw: drop MakeMaker reference
  -:  ---------- > 146:  aeb582a983 mingw: allow building with an MSYS2 runtime v3.x
  -:  ---------- > 147:  e902e9bcae The second batch
  1:  9d318d5106 ! 148:  2f8ba0adf8 commit-graph tests: split up corrupt_graph_and_verify()
    @@ -49,7 +49,7 @@
     -	test_when_finished mv commit-graph-backup $objdir/info/commit-graph &&
     -	cp $objdir/info/commit-graph commit-graph-backup &&
      	printf "$data" | dd of="$objdir/info/commit-graph" bs=1 seek="$pos" conv=notrunc &&
    - 	dd of="$objdir/info/commit-graph" bs=1 seek="$zero_pos" count=0 &&
    + 	dd of="$objdir/info/commit-graph" bs=1 seek="$zero_pos" if=/dev/null &&
      	generate_zero_bytes $(($orig_size - $zero_pos)) >>"$objdir/info/commit-graph" &&
     -	test_must_fail git commit-graph verify 2>test_err &&
     -	grep -v "^+" test_err >err &&
  2:  73849add5e = 149:  800b17edde commit-graph tests: test a graph that's too small
  3:  6bfce758e1 = 150:  7083ab81c7 commit-graph: fix segfault on e.g. "git status"
  4:  ac07ff415e = 151:  d00564ae89 commit-graph: don't early exit(1) on e.g. "git status"
  5:  b2dd394cc7 = 152:  25ee185bf7 commit-graph: don't pass filename to load_commit_graph_one_fd_st()
  6:  9987149e5c ! 153:  7619b46987 commit-graph verify: detect inability to read the graph
    @@ -37,16 +37,10 @@
      
      }
      
    -+test_expect_success 'detect permission problem' '
    ++test_expect_success POSIXPERM,SANITY 'detect permission problem' '
     +	corrupt_graph_setup &&
     +	chmod 000 $objdir/info/commit-graph &&
    -+
    -+	# Skip as root, or in other cases (odd fs or OS) where a
    -+	# "chmod 000 file" does not yield EACCES on e.g. "cat file"
    -+	if ! test -r $objdir/info/commit-graph
    -+	then
    -+		corrupt_graph_verify "Could not open"
    -+	fi
    ++	corrupt_graph_verify "Could not open"
     +'
     +
      test_expect_success 'detect too small' '
  7:  0e35b12a1a ! 154:  17ee4fc050 commit-graph write: don't die if the existing graph is corrupt
    @@ -18,6 +18,10 @@
         use_commit_graph=1 as seen in 177722b344 ("commit: integrate commit
         graph with commit parsing", 2018-04-10).
     
    +    Not using the old graph at all slows down the writing of the new graph
    +    by some small amount, but is a sensible way to prevent an error in the
    +    existing commit-graph from spreading.
    +
         Just fixing the current issue would be likely to result in code that's
         inadvertently broken in the future. New code might use the
         commit-graph at a distance. To detect such cases introduce a
    @@ -36,7 +40,12 @@
         corruption.
     
         This might need to be re-visited if we learn to write the commit-graph
    -    incrementally.
    +    incrementally, but probably not. Hopefully we'll just start by finding
    +    out what commits we have in total, then read the old graph(s) to see
    +    what they cover, and finally write a new graph file with everything
    +    that's missing. In that case the new graph writing code just needs to
    +    continue to use e.g. a parse_commit() that doesn't consult the
    +    existing commit-graphs.
     
         Signed-off-by: Ævar Arnfjörð Bjarmason <avarab@gmail.com>
     
    @@ -119,7 +128,7 @@
      	grep -v "^+" test_err >err &&
      	test_i18ngrep "$grepstr" err &&
     -	git status --short
    -+	if test -z "$NO_WRITE_TEST_BACKUP"
    ++	if test "$2" != "no-copy"
     +	then
     +		cp $objdir/info/commit-graph commit-graph-pre-write-test
     +	fi &&
    @@ -130,14 +139,14 @@
      
      # usage: corrupt_graph_and_verify <position> <data> <string> [<zero_pos>]
     @@
    - 	# "chmod 000 file" does not yield EACCES on e.g. "cat file"
    - 	if ! test -r $objdir/info/commit-graph
    - 	then
    --		corrupt_graph_verify "Could not open"
    -+		NO_WRITE_TEST_BACKUP=1 corrupt_graph_verify "Could not open"
    - 	fi
    + test_expect_success POSIXPERM,SANITY 'detect permission problem' '
    + 	corrupt_graph_setup &&
    + 	chmod 000 $objdir/info/commit-graph &&
    +-	corrupt_graph_verify "Could not open"
    ++	corrupt_graph_verify "Could not open" "no-copy"
      '
      
    + test_expect_success 'detect too small' '
     @@
      	git fsck &&
      	corrupt_graph_and_verify $GRAPH_BYTE_FOOTER "\00" \
  8:  a74d0f0f6f = 155:  29ab2895b7 commit-graph: improve & i18n error messages
-- 
2.21.0.360.g471c308f928

