From b291f64821cd0ccca872ac170898ac73e34189e6 Mon Sep 17 00:00:00 2001
Message-Id: <RFC-cover-v4-0.6-00000000000-20220413T195450Z-avarab@gmail.com>
In-Reply-To: <RFC-cover-v3-0.6-00000000000-20220325T183946Z-avarab@gmail.com>
References: <RFC-cover-v3-0.6-00000000000-20220325T183946Z-avarab@gmail.com>
From: Ævar Arnfjörð Bjarmason <avarab@gmail.com>
Date: Wed, 13 Apr 2022 21:54:50 +0200
Subject: [RFC PATCH v4 0/6] *** SUBJECT HERE ***
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

*** BLURB HERE ***

Johannes Schindelin (6):
  ci: make it easier to find failed tests' logs in the GitHub workflow
  tests: refactor --write-junit-xml code
  test(junit): avoid line feeds in XML attributes
  ci: optionally mark up output in the GitHub workflow
  ci: use `--github-workflow-markup` in the GitHub workflow
  ci: call `finalize_test_case_output` a little later

 .github/workflows/main.yml           |  20 +---
 ci/lib.sh                            |   3 +-
 ci/print-test-failures-github.sh     |  35 +++++++
 t/test-lib-functions.sh              |   4 +-
 t/test-lib-github-workflow-markup.sh |  50 ++++++++++
 t/test-lib-junit.sh                  | 132 +++++++++++++++++++++++++++
 t/test-lib.sh                        | 128 ++++----------------------
 7 files changed, 245 insertions(+), 127 deletions(-)
 create mode 100755 ci/print-test-failures-github.sh
 create mode 100644 t/test-lib-github-workflow-markup.sh
 create mode 100644 t/test-lib-junit.sh

Range-diff against v3:
 1:  4addbd70213 <  -:  ----------- CI: run "set -ex" early in ci/lib.sh
 2:  b23aa99fd37 <  -:  ----------- CI: make "$jobname" explicit, remove fallback
 3:  eec15a95879 <  -:  ----------- CI: remove more dead Travis CI support
 4:  73c894f1665 <  -:  ----------- CI: remove dead "tree skipping" code
 5:  b5e6d538554 <  -:  ----------- CI: remove unused Azure ci/* code
 6:  a4b9febbdca <  -:  ----------- CI: don't have "git grep" invoke a pager in tree content check
 7:  5d46d5b34c9 <  -:  ----------- CI: have "static-analysis" run a "make ci-static-analysis" target
 8:  81e06f13d84 <  -:  ----------- CI: have "static-analysis" run "check-builtins", not "documentation"
 9:  3be91c26d44 <  -:  ----------- CI: move p4 and git-lfs variables to ci/install-dependencies.sh
10:  9dc148341ba <  -:  ----------- CI: consistently use "export" in ci/lib.sh
11:  e9c7ba492e8 <  -:  ----------- CI: export variables via a wrapper
12:  86d5a48d59a <  -:  ----------- CI: remove "run-build-and-tests.sh", run "make [test]" directly
13:  649ad1ae249 <  -:  ----------- CI: check ignored unignored build artifacts in "win[+VS] build" too
14:  b1b5b083389 <  -:  ----------- CI: invoke "make artifacts-tar" directly in windows-build
15:  dfa91ac8938 <  -:  ----------- CI: split up and reduce "ci/test-documentation.sh"
16:  ba4ed216769 <  -:  ----------- CI: combine ci/install{,-docker}-dependencies.sh
17:  b5e89a33340 <  -:  ----------- CI: move "env" definitions into ci/lib.sh
18:  571f4d0f441 <  -:  ----------- ci/run-test-slice.sh: replace shelling out with "echo"
19:  2edea06ee4d <  -:  ----------- CI: pre-select test slice in Windows & VS tests
20:  ef9daa6882f <  -:  ----------- CI: only invoke ci/lib.sh as "steps" in main.yml
21:  44e3ace5fbe <  -:  ----------- CI: narrow down variable definitions in --build and --test
22:  5f56b922e08 <  -:  ----------- CI: add more variables to MAKEFLAGS, except under vs-build
23:  b45b7cec94e <  -:  ----------- CI: set CC in MAKEFLAGS directly, don't add it to the environment
24:  06bf8d9f61b <  -:  ----------- CI: set PYTHON_PATH setting for osx-{clang,gcc} into "$jobname" case
25:  6dc96ba8b82 <  -:  ----------- CI: don't use "set -x" in "ci/lib.sh" output
26:  d88749c60c9 =  1:  cc137c69ee1 ci: make it easier to find failed tests' logs in the GitHub workflow
27:  ad1e1465a81 =  2:  91f96c4f210 tests: refactor --write-junit-xml code
28:  fc96e5b7296 =  3:  84c722969d5 test(junit): avoid line feeds in XML attributes
29:  429c256ac62 =  4:  8acaa800d3a ci: optionally mark up output in the GitHub workflow
30:  72058db67b0 !  5:  4499f743dd1 ci: use `--github-workflow-markup` in the GitHub workflow
    @@ Commit message
         Signed-off-by: Ævar Arnfjörð Bjarmason <avarab@gmail.com>
     
      ## ci/lib.sh ##
    -@@ ci/lib.sh: MAKEFLAGS="DEVELOPER=$DEVELOPER SKIP_DASHED_BUILT_INS=$SKIP_DASHED_BUILT_INS"
    +@@ ci/lib.sh: MAKEFLAGS="$MAKEFLAGS SKIP_DASHED_BUILT_INS=$SKIP_DASHED_BUILT_INS"
      case "$CI_TYPE" in
      github-actions)
    - 	setenv --test GIT_PROVE_OPTS "--timer --jobs 10"
    + 	setenv --test GIT_PROVE_OPTS "--timer --jobs $NPROC"
     -	GIT_TEST_OPTS="--verbose-log -x"
     +	GIT_TEST_OPTS="--verbose-log -x --github-workflow-markup"
    - 	MAKEFLAGS="$MAKEFLAGS --jobs=10"
    ++	MAKEFLAGS="$MAKEFLAGS --jobs=10"
      	test Windows != "$RUNNER_OS" ||
      	GIT_TEST_OPTS="--no-chain-lint --no-bin-wrappers $GIT_TEST_OPTS"
    + 	setenv --test GIT_TEST_OPTS "$GIT_TEST_OPTS"
     
      ## ci/print-test-failures-github.sh ##
     @@ ci/print-test-failures-github.sh: github-actions)
31:  1d2b94436fc !  6:  b291f64821c ci: call `finalize_test_case_output` a little later
    @@ t/test-lib.sh: trap '{ code=$?; set +x; } 2>/dev/null; exit $code' INT TERM HUP
      	test_failure=$(($test_failure + 1))
      	say_color error "not ok $test_count - $1"
      	shift
    - 	printf '%s\n' "$*" | sed -e 's/^/#	/'
    - 	test "$immediate" = "" || _error_exit
    +@@ t/test-lib.sh: test_failure_ () {
    + 		say_color error "1..$test_count"
    + 		_error_exit
    + 	fi
     +	finalize_test_case_output failure "$failure_label" "$@"
      }
      
-- 
2.36.0.rc2.843.g193535c2aa7

